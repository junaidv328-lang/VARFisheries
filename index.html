<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nellore Truck Loader (Supabase)</title>

    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Babel for translating React code in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Import Map with Supabase SDK -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.3"
        }
    }
    </script>

    <!-- Custom Styles -->
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; display: block; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { border-radius: 4px; background-color: #9ca3af; border: 2px solid #f1f1f1; }
        
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-[100dvh] w-screen fixed inset-0 overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <!-- APPLICATION LOGIC -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Truck, Box, Layers, FileText, ArrowRight, RotateCw, RotateCcw, Trash2, Save, Camera, Share2, Plus, X, RefreshCw, Package, User, Users, GripHorizontal, GripVertical, Layout, Grid, BoxSelect, ArrowDownCircle, ArrowUpCircle, Target, AlertCircle, Calendar, Database, Download, History, Info, ChevronDown, ChevronUp, BarChart3, Search, MinusCircle, PlusCircle, CloudOff, FilePlus, FileSpreadsheet, HardDrive, AlertTriangle, ChevronRight, Box as BoxIcon, Pencil, Scale, Image as ImageIcon, ClipboardList, Wallet, IndianRupee, FileText as FilePdf, Cloud, Wifi } from 'lucide-react';
        import { createClient } from '@supabase/supabase-js';

        // --- CONFIGURATION ---
        const supabaseUrl = 'https://wlntnttsliaygrqhfazj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbnRudHRzbGlheWdycWhmYXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzMzNjIsImV4cCI6MjA4MDQwOTM2Mn0.imoQLKoDxDVOmKbLOHVDsRxX5jRORMV5cYt2sFf9wiI';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- CHART COMPONENTS ---
        const SimpleBarChart = ({ data }) => {
            const maxVal = Math.max(...data.map(d => Math.max(d.in, d.out)), 10);
            const height = 150;
            return (
                <div className="flex items-end h-[180px] gap-4 overflow-x-auto pb-6 pt-4 px-2 custom-scroll">
                    {data.map((d, i) => (
                        <div key={i} className="flex flex-col items-center group relative min-w-[30px]">
                            <div className="flex items-end gap-1 border-b border-gray-300 pb-1">
                                <div className="relative flex flex-col justify-end group-hover:opacity-90 transition-all" style={{ height: `${height}px` }}>
                                    <div className="bg-green-500 w-[15px] rounded-t-sm transition-all" style={{ height: `${(d.in / maxVal) * 100}%`, minHeight: d.in > 0 ? '4px' : '0' }}></div>
                                    {d.in > 0 && <span className="absolute -top-4 w-full text-center text-[9px] font-bold text-green-700">{d.in}</span>}
                                </div>
                                <div className="relative flex flex-col justify-end group-hover:opacity-90 transition-all" style={{ height: `${height}px` }}>
                                    <div className="bg-blue-500 w-[15px] rounded-t-sm transition-all" style={{ height: `${(d.out / maxVal) * 100}%`, minHeight: d.out > 0 ? '4px' : '0' }}></div>
                                    {d.out > 0 && <span className="absolute -top-4 w-full text-center text-[9px] font-bold text-blue-700">{d.out}</span>}
                                </div>
                            </div>
                            <div className="text-[9px] font-bold text-gray-600 mt-2 rotate-[-45deg] origin-top-left w-[10px] whitespace-nowrap">{d.label}</div>
                        </div>
                    ))}
                </div>
            );
        };

        const SimpleDonutChart = ({ data }) => {
            const total = data.reduce((sum, d) => sum + d.value, 0);
            if (total === 0) return <div className="text-xs text-gray-400 text-center py-10">No Stock Data</div>;
            let cumulativePercent = 0;
            const slices = data.map((d, i) => {
                const percent = d.value / total;
                const dashArray = `${percent * 100} 100`;
                const dashOffset = -cumulativePercent * 100;
                cumulativePercent += percent;
                return <circle key={i} r="16" cx="16" cy="16" fill="transparent" stroke={d.color} strokeWidth="8" strokeDasharray={dashArray} strokeDashoffset={dashOffset} transform="rotate(-90 16 16)" />;
            });
            return (
                <div className="flex items-center gap-6">
                    <div className="relative w-32 h-32 flex-shrink-0">
                        <svg viewBox="0 0 32 32" className="w-full h-full transform transition-transform hover:scale-105">
                            {slices}
                            <circle r="16" cx="16" cy="16" fill="transparent" stroke="#f3f4f6" strokeWidth="8" style={{zIndex: -1}} />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span className="text-xl font-black text-gray-700">{total}</span>
                            <span className="text-[8px] text-gray-400 uppercase font-bold">Total Boxes</span>
                        </div>
                    </div>
                    <div className="flex-1 space-y-1 overflow-y-auto max-h-[140px] custom-scroll pr-1">
                        {data.sort((a,b) => b.value - a.value).map((d, i) => (
                            <div key={i} className="flex items-center justify-between text-xs">
                                <div className="flex items-center gap-2 max-w-[70%]">
                                    <div className="w-2 h-2 rounded-full flex-shrink-0" style={{ backgroundColor: d.color }}></div>
                                    <span className="text-gray-600 truncate">{d.label}</span>
                                </div>
                                <span className="font-bold">{d.value}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const TruckLoadPlanner = () => {
            // -- State --
            const [driverName, setDriverName] = useState('');
            const [customerName, setCustomerName] = useState('');
            const [varBoxCount, setVarBoxCount] = useState(''); 
            const [operationMode, setOperationMode] = useState('Sales'); 
            const [referenceId, setReferenceId] = useState(''); 
            const [targetBoxCount, setTargetBoxCount] = useState(''); 
            const [tripDate, setTripDate] = useState(new Date().toISOString().split('T')[0]); 

            // Layout
            const [lanes, setLanes] = useState([]);
            const [rows, setRows] = useState([]); 
            const [gridData, setGridData] = useState({});
            const [stackOrientations, setStackOrientations] = useState({}); 
            const [stackHeightOverrides, setStackHeightOverrides] = useState({}); 

            // UI
            const [selectedCell, setSelectedCell] = useState(null); 
            const [activeTab, setActiveTab] = useState('visualizer');
            const [batchInput, setBatchInput] = useState('');
            const [generatedImage, setGeneratedImage] = useState(null);
            const [showAggregatedDetails, setShowAggregatedDetails] = useState(false);
            const [showItemStock, setShowItemStock] = useState(true); 

            // Database Data
            const [savedTrips, setSavedTrips] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [isConnected, setIsConnected] = useState(false);

            // History/Edit
            const [expandedTripId, setExpandedTripId] = useState(null);
            const [visibleRecords, setVisibleRecords] = useState(20); 
            const [selectedItemHistory, setSelectedItemHistory] = useState(null); 
            const [editingTripId, setEditingTripId] = useState(null); 

            // Manual Expenses
            const [expenseCategory, setExpenseCategory] = useState('Labour');
            const [expenseAmount, setExpenseAmount] = useState('');
            const [expenseNote, setExpenseNote] = useState('');

            // Modals
            const [showReportModal, setShowReportModal] = useState(false);
            const [showStockSnapshotModal, setShowStockSnapshotModal] = useState(false);
            const [showVisualReportModal, setShowVisualReportModal] = useState(false);
            const [showDirectEntry, setShowDirectEntry] = useState(false);

            // Direct Entry Form
            const [directData, setDirectData] = useState({ date: new Date().toISOString().split('T')[0], mode: 'Purchase', partyName: '', refId: '', driverName: '', amount: '', items: [] });
            const [newItemName, setNewItemName] = useState('');
            const [newItemBoxes, setNewItemBoxes] = useState(''); 
            const [newItemLooseKg, setNewItemLooseKg] = useState(''); 
            const [tempExpenses, setTempExpenses] = useState([]);
            const [tempExpenseCategory, setTempExpenseCategory] = useState('Transport');
            const [tempExpenseAmount, setTempExpenseAmount] = useState('');

            // Refs
            const captureRef = useRef(null);
            const directEntryCaptureRef = useRef(null);
            const reportCaptureRef = useRef(null);
            const stockCaptureRef = useRef(null);
            const visualReportCaptureRef = useRef(null);

            // --- DATABASE SYNC ---
            const fetchData = async () => {
                const { data: trips, error: tripErr } = await supabase.from('var_truck_trips').select('*').order('timestamp', { ascending: false });
                if (tripErr) { console.error("Trips Error:", tripErr); setIsConnected(false); } else { setSavedTrips(trips || []); setIsConnected(true); }
                const { data: exps, error: expErr } = await supabase.from('var_truck_expenses').select('*').order('timestamp', { ascending: false });
                if (expErr) console.error("Expenses Error:", expErr); else setExpenses(exps || []);
            };

            useEffect(() => {
                fetchData();
                const sub1 = supabase.channel('t1').on('postgres_changes', { event: '*', schema: 'public', table: 'var_truck_trips' }, fetchData).subscribe();
                const sub2 = supabase.channel('t2').on('postgres_changes', { event: '*', schema: 'public', table: 'var_truck_expenses' }, fetchData).subscribe();
                return () => { supabase.removeChannel(sub1); supabase.removeChannel(sub2); };
            }, []);

            // --- HELPERS ---
            const getKey = (t, maj, min, h) => `${t === 'lane' ? 'L' : 'R'}-${maj}-${min}-${h}`;
            const getStackConfigKey = (t, maj, min) => `${t === 'lane' ? 'L' : 'R'}-${maj}-${min}`;
            const getBox = (t, maj, min, h) => gridData[getKey(t, maj, min, h)] || { id: getKey(t, maj, min, h), label: '', filled: false };
            const getStackHeight = (t, maj, min) => {
                const ov = stackHeightOverrides[getStackConfigKey(t, maj, min)];
                if (ov !== undefined) return ov;
                return t === 'lane' ? (lanes.find(l => l.id === maj)?.height || 5) : (rows[maj]?.height || 5);
            };
            const getStackOrientation = (t, maj, min) => stackOrientations[getStackConfigKey(t, maj, min)] || 'Horizontal';

            // --- LAYOUT ACTIONS ---
            const toggleStackOrientation = (t, maj, min) => {
                const k = getStackConfigKey(t, maj, min);
                setStackOrientations(p => ({ ...p, [k]: (p[k] || 'Horizontal') === 'Horizontal' ? 'Vertical' : 'Horizontal' }));
            };
            const adjustStackHeight = (t, maj, min, d) => {
                const k = getStackConfigKey(t, maj, min);
                setStackHeightOverrides(p => ({ ...p, [k]: Math.max(1, Math.min(15, getStackHeight(t, maj, min) + d)) }));
            };
            const updateBox = (t, maj, min, h, ups) => {
                const k = getKey(t, maj, min, h);
                setGridData(p => ({ ...p, [k]: { ...getBox(t, maj, min, h), ...ups } }));
            };
            const fillStack = (t, maj, min) => {
                if (!batchInput) return;
                const h = getStackHeight(t, maj, min);
                const n = { ...gridData };
                for (let i = 0; i < h; i++) { const k = getKey(t, maj, min, i); n[k] = { id: k, label: batchInput, filled: true }; }
                setGridData(n);
            };
            const resetGrid = () => { setGridData({}); setStackOrientations({}); setStackHeightOverrides({}); setGeneratedImage(null); setBatchInput(''); };
            const manualReset = () => { if (confirm("Clear layout?")) { resetGrid(); if (activeTab === 'share') setActiveTab('visualizer'); } };
            const resetConfig = () => { if (confirm("Reset ALL config?")) { setLanes([]); setRows([]); setGridData({}); setStackOrientations({}); setStackHeightOverrides({}); } };

            const addLane = () => lanes.length < 5 && setLanes([...lanes, { id: Date.now(), name: `Lane ${lanes.length + 1}`, stacks: 4, height: 5 }]);
            const removeLane = (id) => setLanes(lanes.filter(l => l.id !== id));
            const updateLane = (id, f, v) => setLanes(lanes.map(l => l.id === id ? { ...l, [f]: parseInt(v) || 0 } : l));
            const addRow = () => setRows([...rows, { id: Date.now(), cols: 3, height: 5 }]);
            const removeRow = (idx) => { const n = [...rows]; n.splice(idx, 1); setRows(n); };
            const updateRow = (idx, f, v) => { const n = [...rows]; n[idx][f] = parseInt(v) || 0; setRows(n); };

            // --- DATA AGGREGATION ---
            const getManifestData = () => {
                let total = 0; const summary = {};
                const tally = (l) => { const k = l ? l.trim() : 'Unlabeled'; summary[k] = (summary[k] || 0) + 1; };
                lanes.forEach(l => { for (let s = 0; s < l.stacks; s++) { const h = getStackHeight('lane', l.id, s); for (let i = 0; i < h; i++) { const b = getBox('lane', l.id, s, i); if (b.filled) { total++; tally(b.label); } } } });
                rows.forEach((r, ri) => { for (let c = 0; c < r.cols; c++) { const h = getStackHeight('row', ri, c); for (let i = 0; i < h; i++) { const b = getBox('row', ri, c, i); if (b.filled) { total++; tally(b.label); } } } });
                return { total, summary };
            };
            
            const generateManifestText = () => {
                const { total, summary } = getManifestData();
                let t = `MANIFEST - ${operationMode.toUpperCase()}\nDATE: ${tripDate}\nDRIVER: ${driverName}\nREF: ${referenceId}\nTARGET: ${targetBoxCount}\nACTUAL: ${total}\n----------------\n`;
                Object.keys(summary).forEach(k => { if (!k.startsWith('__')) t += `${k}: ${summary[k]}\n`; });
                return t;
            };

            const stockTotals = useMemo(() => {
                let p = 0, s = 0, items = {};
                savedTrips.forEach(t => {
                    const m = t.operationMode; const boxes = Number(t.totalBoxes)||0;
                    if (m === 'Purchase') p += boxes; else s += boxes;
                    const proc = (name, b, l) => {
                        const n = name.trim();
                        if (!items[n]) items[n] = { in: {b:0, l:0}, out: {b:0, l:0} };
                        if (m === 'Purchase') { items[n].in.b += b; items[n].in.l += l; } else { items[n].out.b += b; items[n].out.l += l; }
                    };
                    if (t.detailedItems) t.detailedItems.forEach(i => proc(i.name, Number(i.boxes)||0, Number(i.looseKg)||0));
                    else if (t.summary) Object.keys(t.summary).forEach(k => { if (!k.startsWith('__')) proc(k, Number(t.summary[k]), 0); });
                });
                return { p, s, bal: p - s, items };
            }, [savedTrips]);

            const uniqueItems = useMemo(() => {
                const s = new Set();
                savedTrips.forEach(t => {
                    if (t.detailedItems) t.detailedItems.forEach(i => s.add(i.name));
                    else if (t.summary) Object.keys(t.summary).forEach(k => !k.startsWith('__') && s.add(k));
                });
                return Array.from(s).sort();
            }, [savedTrips]);

            const getDailyReport = (date) => {
                const p = [], s = [];
                let tInB=0, tInL=0, tOutB=0, tOutL=0;
                
                // Manual Expenses
                const manualExps = expenses.filter(e => e.date === date);
                // Trip Expenses & Amounts
                const trips = savedTrips.filter(t => t.tripDate === date);
                
                const tripExps = trips.flatMap(t => {
                    const es = t.summary?.['__expenses'] || t.additional_expenses || [];
                    return Array.isArray(es) ? es.map(e => ({...e, source: 'trip', party: t.customerName})) : [];
                });
                
                const allExps = [...manualExps, ...tripExps];
                const totalExp = allExps.reduce((acc, e) => acc + (Number(e.amount)||0), 0);

                trips.forEach(t => {
                    const party = t.customerName || 'Unknown';
                    const list = t.operationMode === 'Purchase' ? p : s;
                    let obj = list.find(x => x.name === party);
                    if (!obj) { obj = { name: party, items: [], totalB:0, totalL:0, notes:[], amount:0 }; list.push(obj); }
                    
                    const amt = t.summary?.['__transaction_amount'] || t.transactionAmount || 0;
                    if (amt) obj.amount += parseFloat(amt);
                    if (t.driverName && !obj.notes.includes(t.driverName)) obj.notes.push(t.driverName);

                    const items = t.detailedItems || Object.entries(t.summary).filter(([k]) => !k.startsWith('__')).map(([n,c]) => ({ name: n, boxes: c, looseKg: 0 }));
                    
                    items.forEach(i => {
                        const exI = obj.items.find(x => x.name === i.name);
                        const b = Number(i.boxes)||0; const l = Number(i.looseKg)||0;
                        if (exI) { exI.boxes += b; exI.looseKg += l; } else obj.items.push({ name: i.name, boxes: b, looseKg: l });
                        
                        obj.totalB += b; obj.totalL += l;
                        if (t.operationMode === 'Purchase') { tInB += b; tInL += l; } else { tOutB += b; tOutL += l; }
                    });
                });
                return { purchases: p, sales: s, totalIn: tInB, totalOut: tOutB, totalExp, allExps };
            };

            // --- DATABASE ACTIONS ---
            const saveTrip = async () => {
                const { total, summary } = getManifestData();
                if (total === 0) return alert("Empty trip");
                const items = Object.entries(summary).filter(([k]) => !k.startsWith('__')).map(([n, c]) => ({ name: n, boxes: c, looseKg: 0, totalWeight: c * 35 }));
                
                try {
                    const { error } = await supabase.from('var_truck_trips').insert([{
                        id: Date.now(), timestamp: Date.now(), tripDate, operationMode, driverName, customerName, referenceId,
                        targetBoxCount: targetBoxCount ? parseInt(targetBoxCount) : 0, varBoxCount: varBoxCount ? parseInt(varBoxCount) : 0,
                        totalBoxes: total, summary, detailedItems: items, isDirectEntry: false
                    }]);
                    if (error) throw error;
                    alert("Saved!"); resetGrid();
                } catch (e) { alert("Save error: " + e.message); }
            };

            const addExpense = async () => {
                if (!expenseAmount) return;
                const newExp = { id: Date.now(), timestamp: Date.now(), date: reportDate, category: expenseCategory, amount: parseFloat(expenseAmount), note: expenseNote, tripID: 0 };
                setExpenses(prev => [newExp, ...prev]); // Optimistic
                setExpenseAmount(''); setExpenseNote('');
                
                try {
                    const { error } = await supabase.from('var_truck_expenses').insert([newExp]);
                    if (error) {
                        // Fallback for column casing
                        if (error.message.includes('column "tripID"')) {
                            const retry = { ...newExp }; delete retry.tripID; retry.trip_id = 0;
                            await supabase.from('var_truck_expenses').insert([retry]);
                        } else throw error;
                    }
                } catch (e) {
                    console.error(e); alert("Expense save failed: " + e.message);
                    setExpenses(prev => prev.filter(x => x.id !== newExp.id)); // Rollback
                }
            };

            const deleteExpense = async (id) => {
                if (confirm("Delete?")) {
                    setExpenses(prev => prev.filter(e => e.id !== id));
                    try { await supabase.from('var_truck_expenses').delete().eq('id', id); } catch(e) { alert("Delete failed"); }
                }
            };

            const clearHistory = async () => {
                if (prompt("Admin Password:") !== "1234") return alert("Wrong Password");
                if (!confirm("Delete ALL cloud data?")) return;
                try {
                    await supabase.from('var_truck_trips').delete().neq('id', 0);
                    await supabase.from('var_truck_expenses').delete().neq('id', 0);
                    alert("Cleared"); fetchData();
                } catch (e) { alert("Error clearing"); }
            };

            // --- DIRECT ENTRY ACTIONS ---
            const handleDirectSave = async () => {
                if (!directData.items.length || !directData.partyName) return alert("Missing info");
                let total = 0; const sum = {};
                directData.items.forEach(i => { total += i.boxes; sum[i.name.trim()] = (sum[i.name.trim()]||0) + i.boxes; });
                if (directData.amount) sum['__transaction_amount'] = parseFloat(directData.amount);
                if (tempExpenses.length) sum['__expenses'] = tempExpenses;

                const recId = editingTripId || Date.now();
                const trip = {
                    id: recId, timestamp: Date.now(), tripDate: directData.date, operationMode: directData.mode,
                    customerName: directData.partyName, referenceId: directData.refId || 'DIRECT', totalBoxes: total,
                    summary: sum, detailedItems: directData.items, isDirectEntry: true, driverName: directData.driverName || 'Direct Entry'
                };

                try {
                    const { error } = await supabase.from('var_truck_trips').upsert(trip);
                    if (error) throw error;
                    alert("Saved!"); setShowDirectEntry(false); setEditingTripId(null); setDirectData({ date: reportDate, mode: 'Purchase', partyName: '', refId: '', driverName: '', amount: '', items: [] }); setTempExpenses([]);
                    return true;
                } catch (e) { alert("Save error: " + e.message); return false; }
            };

            const handleDirectShare = async () => {
                if (!directData.items.length || !directData.partyName) return alert("Missing info");
                if (!directEntryCaptureRef.current) return;
                try {
                    const canvas = await window.html2canvas(directEntryCaptureRef.current, { scale: 2, backgroundColor: '#fff' });
                    const blob = await new Promise(r => canvas.toBlob(r));
                    const file = new File([blob], `Receipt_${directData.partyName}.png`, { type: 'image/png' });
                    if (navigator.share) await navigator.share({ files: [file] });
                    else { const a = document.createElement('a'); a.href = URL.createObjectURL(file); a.download = file.name; a.click(); }
                } catch (e) { alert("Image gen failed"); }
            };

            // --- PDF/IMAGE GENERATION ---
            const generateImage = async (ref, name) => {
                if (!ref.current) return;
                try {
                    // Clone to ensure full visibility for capture
                    const clone = ref.current.cloneNode(true);
                    clone.style.width = '800px'; clone.style.position = 'fixed'; clone.style.top = '-9999px'; clone.style.left = '0'; clone.style.backgroundColor = '#fff';
                    document.body.appendChild(clone);
                    const canvas = await window.html2canvas(clone, { scale: 2 });
                    document.body.removeChild(clone);
                    return { canvas, blob: await new Promise(r => canvas.toBlob(r)) };
                } catch (e) { console.error(e); return null; }
            };

            const handlePDFReport = async (visual) => {
                const ref = visual ? visualReportCaptureRef : reportCaptureRef;
                const res = await generateImage(ref);
                if (!res) return alert("Error generating");
                const pdf = new window.jspdf.jsPDF('p', 'mm', [210, 297]);
                const h = (res.canvas.height * 210) / res.canvas.width;
                pdf.addImage(res.canvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, 210, Math.min(h, 297));
                if (navigator.share) {
                    const f = new File([pdf.output('blob')], `Report_${reportDate}.pdf`, { type: 'application/pdf' });
                    await navigator.share({ files: [f] });
                } else pdf.save(`Report_${reportDate}.pdf`);
            };

            const handleSnapshot = async () => {
                const res = await generateImage(stockCaptureRef);
                if (!res) return;
                const f = new File([res.blob], "Stock.png", { type: 'image/png' });
                if (navigator.share) await navigator.share({ files: [f] }); else { const a = document.createElement('a'); a.href = URL.createObjectURL(f); a.download = f.name; a.click(); }
            };

            // --- RENDER HELPERS ---
            const renderCell = (t, maj, min, label) => {
                const k = getKey(t, maj, min); const b = gridData[k]; const h = getStackHeight(t, maj, min); const filledCount = Object.keys(gridData).filter(key => key.startsWith(k.replace(/-\d+$/, '-')) && gridData[key]?.filled).length;
                const isSel = selectedCell?.type === t && selectedCell.laneId === maj && selectedCell.stackIdx === min;
                if (activeTab === 'share') {
                     // Static render for photo
                     const boxes = []; for(let i=h-1; i>=0; i--) { const bx=getBox(t,maj,min,i); boxes.push(<div key={i} className={`flex-1 flex items-center justify-center text-[9px] border-b border-white/20 ${bx.filled?'bg-blue-600 text-white':'bg-gray-100 text-gray-300'}`}>{bx.filled?bx.label||'I':'-'}</div>); }
                     return <div className="border border-gray-300 rounded overflow-hidden flex flex-col bg-gray-50" style={{height: `${16+(h*24)}px`}}><div className="bg-gray-200 text-[8px] font-bold px-1">{label}</div><div className="flex-1 flex flex-col">{boxes}</div></div>;
                }
                return (
                    <div onClick={() => setSelectedCell(t==='lane'?{type:'lane',laneId:maj,stackIdx:min}:{type:'row',rowIdx:maj,colIdx:min})} className={`h-16 border-2 border-dashed rounded-lg flex flex-col items-center justify-center relative cursor-pointer ${filledCount>0?'bg-blue-100':''} ${filledCount===h?'bg-blue-500 text-white':''} ${isSel?'ring-4 ring-yellow-400':''}`}>
                        <span className="font-bold">{filledCount}</span><span className="absolute top-1 left-1 text-[8px] opacity-50">{label}</span>
                        <div className="absolute bottom-1 flex gap-0.5">{[...Array(h)].map((_,i)=><div key={i} className={`w-1 h-1 rounded-full ${i<filledCount?'bg-green-400':'bg-gray-300'}`}/>)}</div>
                    </div>
                );
            };

            const renderStackEditor = () => {
                if(!selectedCell) return null;
                const { type, laneId, stackIdx, rowIdx, colIdx } = selectedCell;
                const maj = type === 'lane' ? laneId : rowIdx;
                const min = type === 'lane' ? stackIdx : colIdx;
                const h = getStackHeight(type, maj, min);
                const boxes = [];
                for (let i=h-1; i>=0; i--) {
                    const b = getBox(type, maj, min, i);
                    boxes.push(<div key={i} className={`p-2 border mb-1 rounded flex justify-between items-center text-xs ${b.filled?'bg-blue-100 border-blue-200':'bg-white'}`}><span>Slot {i+1}</span><div className="flex gap-2 font-bold">{b.filled?b.label:'Empty'}{b.filled?<button onClick={()=>updateBox(type,maj,min,i,{filled:false,label:''})}><Trash2 size={14}/></button>:<button onClick={()=>updateBox(type,maj,min,i,{filled:true,label:batchInput})} className="text-green-600"><Plus size={14}/></button>}</div></div>);
                }
                return (
                    <div className="flex flex-col h-full">
                        <div className="flex justify-between items-center mb-2"><h3 className="font-bold">Edit Stack</h3><button onClick={()=>fillStack(type,maj,min)} className="text-xs bg-blue-100 px-2 py-1 rounded">Fill All</button></div>
                        <div className="flex items-center justify-between mb-4 border p-2 rounded">
                            <span className="text-xs font-bold uppercase">Height: {h}</span>
                            <div className="flex gap-2"><button onClick={()=>adjustStackHeight(type,maj,min,-1)}><MinusCircle size={16}/></button><button onClick={()=>adjustStackHeight(type,maj,min,1)}><PlusCircle size={16}/></button></div>
                        </div>
                        <div className="flex-1 overflow-y-auto">{boxes}</div>
                    </div>
                );
            };

            // --- MAIN RENDER ---
            return (
                <div className="flex flex-col h-full w-full bg-gray-100 max-w-md mx-auto shadow-2xl overflow-hidden font-sans">
                    <datalist id="item-suggestions">{uniqueItems.map(n=><option key={n} value={n}/>)}</datalist>

                    {/* HEADER */}
                    <div className={`text-white p-4 flex justify-between items-center shadow-lg z-10 ${operationMode==='Sales'?'bg-blue-900':'bg-green-800'}`}>
                        <div className="flex items-center gap-2">
                            {operationMode==='Sales'?<ArrowUpCircle size={24} className="text-blue-300"/>:<ArrowDownCircle size={24} className="text-green-300"/>}
                            <div><h1 className="font-bold text-lg leading-tight">VAR Load Planner</h1><div className="text-[10px] uppercase tracking-widest font-bold opacity-80">{operationMode}</div></div>
                        </div>
                        <div className="text-right text-xs"><div className="opacity-60 font-bold uppercase">Supabase</div><div className={`flex items-center justify-end gap-1 ${isConnected?'text-green-300':'text-red-300'}`}><Cloud size={10}/> {isConnected?'On':'Off'}</div></div>
                    </div>

                    {/* CONTENT */}
                    <div className="flex-1 overflow-y-auto p-4 relative bg-gray-50 custom-scroll">
                        
                        {/* VISUALIZER TAB */}
                        {activeTab === 'visualizer' && (
                            <>
                                <div className="bg-white p-3 shadow-sm rounded mb-4">
                                    <div className="flex gap-2 mb-2"><input list="item-suggestions" className="flex-1 border p-2 rounded text-sm" placeholder="Item Name (e.g. Rohu)" value={batchInput} onChange={e=>setBatchInput(e.target.value)} /><button onClick={manualReset} className="bg-red-50 text-red-600 p-2 rounded border border-red-200"><RotateCcw size={18}/></button></div>
                                    <button onClick={()=>setSelectedItemHistory('ALL_ITEMS_VIEW')} className="w-full py-2 bg-blue-50 text-blue-700 font-bold text-xs rounded border border-blue-200 flex items-center justify-center gap-2"><BoxIcon size={14}/> Check Available Stock</button>
                                </div>
                                {selectedCell && <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-sm p-4 rounded-xl shadow-2xl h-[400px]" onClick={e=>e.stopPropagation()}><div className="flex justify-end"><button onClick={()=>setSelectedCell(null)}><X/></button></div>{renderStackEditor()}</div></div>}
                                
                                <div className="flex flex-col gap-4 pb-8">
                                    {lanes.length>0 && <div className="flex gap-2 overflow-x-auto pb-2">{lanes.map((l,i)=><div key={l.id} className="min-w-[60px] flex-1 flex flex-col gap-1"><div className="text-center text-[10px] font-bold text-gray-400">L{i+1}</div>{[...Array(l.stacks)].map((_,s)=><div key={s}>{renderCell('lane',l.id,s,`S${s+1}`)}</div>)}</div>)}</div>}
                                    {rows.length>0 && <div className="space-y-2">{rows.map((r,i)=><div key={r.id} className="grid gap-2" style={{gridTemplateColumns:`repeat(${r.cols},1fr)`}}>{[...Array(r.cols)].map((_,c)=><div key={c}>{renderCell('row',i,c,`C${c+1}`)}</div>)}</div>)}</div>}
                                    {lanes.length===0 && rows.length===0 && <div className="text-center py-10 text-gray-400 italic">No layout configured. Go to Config.</div>}
                                </div>
                            </>
                        )}

                        {/* SHARE PHOTO TAB */}
                        {activeTab === 'share' && (
                            <div className="flex flex-col h-full">
                                <div className="mb-4 text-center">
                                    <button onClick={async () => { const res = await generateImage(captureRef); if(res) setGeneratedImage(res.canvas.toDataURL()); }} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 mb-2"><Camera size={20}/> Snap Layout</button>
                                    {generatedImage && <div className="border p-2 bg-white"><img src={generatedImage} className="w-full mb-2"/><a href={generatedImage} download="layout.png" className="block bg-green-500 text-white py-2 rounded text-center text-sm font-bold">Download Image</a></div>}
                                </div>
                                <div ref={captureRef} className="bg-white p-6 border rounded shadow-sm min-h-[600px]">
                                    <div className="border-b-2 pb-4 mb-6 flex justify-between"><div><h1 className="text-2xl font-black uppercase">Load Plan</h1><div>{driverName}</div></div><div className="text-right text-xl font-bold">{getManifestData().total} Bx</div></div>
                                    <div className="pl-6 relative border-l-2 border-dashed border-gray-300">
                                        <div className="absolute left-[-12px] top-1/2 -rotate-90 text-xs text-gray-400 font-bold bg-white px-1">CABIN</div>
                                        {lanes.map((l,i)=><div key={l.id} className="flex gap-1 mb-2">{[...Array(l.stacks)].map((_,s)=>renderCell('lane',l.id,s,''))}</div>)}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* MANIFEST TAB */}
                        {activeTab === 'manifest' && (
                            <div className="bg-white p-4 rounded shadow h-full flex flex-col">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><FileText size={20} /> Load Manifest</h3>
                                <textarea readOnly className="flex-1 bg-gray-50 p-4 rounded text-xs font-mono border resize-none focus:outline-none" value={generateManifestText()}></textarea>
                                <div className="mt-4 grid grid-cols-2 gap-2">
                                    <button onClick={() => navigator.clipboard.writeText(generateManifestText())} className="bg-blue-900 text-white py-3 rounded font-bold">Copy Text</button>
                                    <button onClick={saveTrip} className="bg-green-600 text-white py-3 rounded font-bold">Save Trip</button>
                                </div>
                            </div>
                        )}

                        {/* DAILY TAB */}
                        {activeTab === 'daily' && (
                            <div className="space-y-4">
                                <div className="bg-white p-4 rounded shadow">
                                    <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><Calendar size={18}/> Daily Reports</h3>
                                    <input type="date" value={reportDate} onChange={e=>setReportDate(e.target.value)} className="w-full border p-2 rounded mb-3"/>
                                    <div className="grid grid-cols-1 gap-2">
                                        <button onClick={()=>setShowVisualReportModal(true)} className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-bold shadow flex items-center justify-center gap-2"><BarChart3 size={18}/> View Charts (Visual)</button>
                                        <button onClick={()=>{setShowVisualReportModal(false); setShowReportModal(true);}} className="border border-purple-200 text-purple-700 bg-white py-2 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-purple-50"><FileText size={16}/> View Text Report</button>
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded shadow border-l-4 border-orange-400">
                                    <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><Wallet size={18}/> Daily Expenses</h3>
                                    <div className="flex gap-2 mb-2">
                                        <input type="number" placeholder="₹" value={expenseAmount} onChange={e=>setExpenseAmount(e.target.value)} className="w-20 border p-2 rounded text-sm"/>
                                        <input type="text" placeholder="Note" value={expenseNote} onChange={e=>setExpenseNote(e.target.value)} className="flex-1 border p-2 rounded text-sm"/>
                                        <button onClick={addExpense} className="bg-orange-500 text-white px-3 rounded"><Plus/></button>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto pb-2">{['Labour','Ice','Transport','Driver Beta','Other'].map(c=><button key={c} onClick={()=>setExpenseCategory(c)} className={`text-[10px] px-2 py-1 rounded border whitespace-nowrap ${expenseCategory===c?'bg-orange-100 border-orange-300 text-orange-800':'bg-gray-50'}`}>{c}</button>)}</div>
                                    <div className="mt-2 space-y-2 max-h-40 overflow-y-auto custom-scroll">
                                        {getDailyReport(reportDate).allExps.filter(e=>!e.source).map((e,i)=>(<div key={i} className="flex justify-between text-xs bg-gray-50 p-2 rounded"><span>{e.category} <span className="text-gray-400">({e.note})</span></span><div className="flex items-center gap-2 font-bold">₹{e.amount}<button onClick={()=>deleteExpense(e.id)} className="text-red-500"><X size={12}/></button></div></div>))}
                                    </div>
                                    <div className="text-right text-xs font-bold mt-2 text-gray-500">Total: ₹{getDailyReport(reportDate).totalExp}</div>
                                </div>
                            </div>
                        )}

                        {/* RECORDS TAB */}
                        {activeTab === 'records' && (
                            <div className="space-y-4">
                                {!selectedItemHistory ? (
                                    <>
                                        <div className="bg-gray-900 text-white p-5 rounded-xl shadow-lg">
                                            <div className="text-xs text-gray-400 uppercase font-bold tracking-widest mb-4">Inventory Overview</div>
                                            <div className="flex justify-between items-end">
                                                <div className="text-center"><div className="text-2xl font-black text-green-400">{stockTotals.p}</div><div className="text-[10px] uppercase">Inward</div></div>
                                                <ArrowRight className="text-gray-600 mb-2"/>
                                                <div className="text-center"><div className="text-2xl font-black text-blue-400">{stockTotals.s}</div><div className="text-[10px] uppercase">Outward</div></div>
                                                <div className="text-right"><div className="text-4xl font-black text-white">{stockTotals.bal}</div><div className="text-[10px] uppercase text-yellow-500">Current Stock</div></div>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 gap-3">
                                            <button onClick={()=>{setEditingTripId(null); setDirectData({date:reportDate, mode:'Purchase', partyName:'', refId:'', driverName:'', amount:'', items:[]}); setShowDirectEntry(true);}} className="bg-white border-2 border-dashed border-green-300 text-green-700 py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-green-50"><FilePlus size={18}/> Add Direct Entry</button>
                                            <button onClick={()=>setSelectedItemHistory('ALL')} className="bg-white border border-gray-200 text-gray-700 py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm"><BoxIcon size={18}/> View Item-wise Stock</button>
                                        </div>
                                        <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                                            <div className="bg-gray-50 p-2 text-xs font-bold text-gray-500 uppercase border-b">Recent Activity</div>
                                            {savedTrips.slice(0, visibleRecords).map(t=>(
                                                <div key={t.id} onClick={()=>setExpandedTripId(expandedTripId===t.id?null:t.id)} className="p-3 border-b last:border-0 hover:bg-gray-50 cursor-pointer">
                                                    <div className="flex justify-between items-start">
                                                        <div><div className="font-bold text-sm">{t.customerName||'Unknown'}</div><div className="text-xs text-gray-500">{t.tripDate} {t.isDirectEntry && <span className="text-[9px] bg-purple-100 text-purple-700 px-1 rounded ml-1">DIRECT</span>}</div></div>
                                                        <div className={`font-black ${t.operationMode==='Purchase'?'text-green-600':'text-blue-600'}`}>{t.operationMode==='Purchase'?'+':'-'}{t.totalBoxes}</div>
                                                    </div>
                                                    {expandedTripId===t.id && (
                                                        <div className="mt-2 pt-2 border-t text-xs space-y-2 animate-fade-in">
                                                            <div className="grid grid-cols-2 gap-2 text-gray-600">
                                                                {(t.detailedItems||[]).map((i,k)=><div key={k} className="flex justify-between bg-gray-50 p-1 rounded"><span>{i.name}</span><b>{i.boxes}</b></div>)}
                                                            </div>
                                                            <div className="flex justify-end gap-2"><button onClick={(e)=>{e.stopPropagation(); openEditRecord(t);}} className="text-blue-600 font-bold">Edit</button><button onClick={(e)=>{e.stopPropagation(); deleteTrip(t.id);}} className="text-red-600 font-bold">Delete</button></div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                            <button onClick={()=>setVisibleRecords(p=>p+20)} className="w-full py-2 text-xs text-center text-gray-400 hover:bg-gray-50">Show More</button>
                                        </div>
                                    </>
                                ) : (
                                    // Stock View
                                    <div className="bg-white h-full flex flex-col">
                                        <div className="p-4 border-b flex justify-between items-center"><button onClick={()=>setSelectedItemHistory(null)} className="flex items-center gap-1 text-sm font-bold text-gray-600"><ArrowRight className="rotate-180" size={16}/> Back</button><h3 className="font-bold">Stock Report</h3></div>
                                        <div className="flex-1 overflow-auto bg-gray-50 p-4">
                                            <div ref={stockCaptureRef} className="bg-white p-6 shadow-lg min-h-full">
                                                <div className="text-center border-b-2 border-black pb-4 mb-6"><h1 className="text-2xl font-black uppercase">Stock Balance</h1><div className="text-gray-500 font-bold">{new Date().toDateString()}</div></div>
                                                <table className="w-full text-sm">
                                                    <thead><tr className="border-b-2 border-black text-left uppercase text-xs text-gray-500"><th className="py-2">Item</th><th className="text-right">In</th><th className="text-right">Out</th><th className="text-right text-black">Bal</th></tr></thead>
                                                    <tbody className="divide-y">{Object.entries(stockTotals.items).map(([k,v])=>(<tr key={k}><td className="py-2 font-bold">{k}</td><td className="text-right text-green-600">{v.in.b}</td><td className="text-right text-blue-600">{v.out.b}</td><td className="text-right font-black">{v.in.b-v.out.b}</td></tr>))}</tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div className="p-4 border-t"><button onClick={handleSnapshot} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"><Camera size={20}/> Share Image</button></div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* --- SETTINGS TAB --- */}
                        {activeTab === 'settings' && (
                            <div className="bg-white p-4 rounded shadow space-y-6">
                                <h3 className="font-bold text-lg flex items-center gap-2"><Truck/> Settings</h3>
                                <div className="space-y-3">
                                    <label className="text-xs font-bold uppercase text-gray-500">Trip Defaults</label>
                                    <div className="grid grid-cols-2 gap-2"><button onClick={()=>setOperationMode('Sales')} className={`p-2 border rounded text-xs font-bold ${operationMode==='Sales'?'bg-blue-500 text-white':'bg-white'}`}>Sales</button><button onClick={()=>setOperationMode('Purchase')} className={`p-2 border rounded text-xs font-bold ${operationMode==='Purchase'?'bg-green-600 text-white':'bg-white'}`}>Purchase</button></div>
                                    <input type="text" placeholder="Driver Name" value={driverName} onChange={e=>setDriverName(e.target.value)} className="w-full border p-2 rounded text-sm"/>
                                    <input type="text" placeholder="Customer Name" value={customerName} onChange={e=>setCustomerName(e.target.value)} className="w-full border p-2 rounded text-sm"/>
                                </div>
                                <div className="space-y-3 border-t pt-4">
                                    <label className="text-xs font-bold uppercase text-gray-500">Layout</label>
                                    <div className="flex gap-2"><button onClick={addLane} className="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold">+ Lane</button><button onClick={addRow} className="bg-orange-100 text-orange-700 px-3 py-1 rounded text-xs font-bold">+ Row</button></div>
                                    {lanes.map((l,i)=><div key={l.id} className="flex gap-2 items-center bg-gray-50 p-2 rounded"><span className="text-xs font-bold w-6">L{i+1}</span><input type="number" value={l.stacks} onChange={e=>updateLane(l.id,'stacks',e.target.value)} className="w-12 border rounded text-center"/><input type="number" value={l.height} onChange={e=>updateLane(l.id,'height',e.target.value)} className="w-12 border rounded text-center"/><button onClick={()=>removeLane(l.id)}><X size={14}/></button></div>)}
                                    {rows.map((r,i)=><div key={r.id} className="flex gap-2 items-center bg-gray-50 p-2 rounded"><span className="text-xs font-bold w-6">R{i+1}</span><input type="number" value={r.cols} onChange={e=>updateRow(i,'cols',e.target.value)} className="w-12 border rounded text-center"/><input type="number" value={r.height} onChange={e=>updateRow(i,'height',e.target.value)} className="w-12 border rounded text-center"/><button onClick={()=>removeRow(i)}><X size={14}/></button></div>)}
                                </div>
                                <div className="pt-6 border-t"><button onClick={clearHistory} className="w-full bg-red-50 text-red-600 border border-red-200 py-3 rounded font-bold text-sm">Clear All History (Danger)</button></div>
                            </div>
                        )}
                    </div>

                    {/* MODALS */}
                    {/* Visual Report Modal */}
                    {showVisualReportModal && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-5xl h-[90vh] rounded-xl flex flex-col overflow-hidden">
                                <div className="p-4 border-b flex justify-between items-center"><h3 className="font-bold text-lg">Visual Report</h3><button onClick={()=>setShowVisualReportModal(false)}><X/></button></div>
                                <div className="flex-1 overflow-auto bg-gray-100 p-8 flex justify-center">
                                    <div ref={visualReportCaptureRef} className="bg-white p-8 w-[800px] shadow-xl text-gray-800">
                                        <div className="flex justify-between border-b-2 border-black pb-4 mb-6"><div><h1 className="text-3xl font-black uppercase">Daily Summary</h1><div>{new Date(reportDate).toDateString()}</div></div></div>
                                        {(() => {
                                            const s = getDailyReport(reportDate);
                                            const chartData = Array.from(new Set([...s.purchases.map(p=>p.name), ...s.sales.map(x=>x.name)])).map(n => ({ label: n, in: s.purchases.find(p=>p.name===n)?.totalB||0, out: s.sales.find(x=>x.name===n)?.totalB||0 }));
                                            const stockData = Object.entries(stockTotals.items).map(([k,v], i) => ({ label: k, value: v.in.b - v.out.b, color: ['#3b82f6','#10b981','#f59e0b','#ef4444'][i%4] })).filter(d=>d.value>0);
                                            return (
                                                <div className="space-y-8">
                                                    <div className="grid grid-cols-3 gap-4">
                                                        <div className="bg-green-50 p-4 rounded border border-green-200"><div className="text-xs font-bold text-green-700 uppercase">Inward</div><div className="text-3xl font-black text-green-900">{s.totalIn}</div></div>
                                                        <div className="bg-blue-50 p-4 rounded border border-blue-200"><div className="text-xs font-bold text-blue-700 uppercase">Outward</div><div className="text-3xl font-black text-blue-900">{s.totalOut}</div></div>
                                                        <div className="bg-gray-50 p-4 rounded border border-gray-200"><div className="text-xs font-bold text-gray-500 uppercase">Net</div><div className="text-3xl font-black">{s.totalIn - s.totalOut}</div></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-8"><div className="border rounded p-4"><h4 className="font-bold mb-4 text-xs uppercase">Activity</h4><SimpleBarChart data={chartData}/></div><div className="border rounded p-4"><h4 className="font-bold mb-4 text-xs uppercase">Stock Composition</h4><SimpleDonutChart data={stockData}/></div></div>
                                                    <table className="w-full text-sm border">
                                                        <thead className="bg-gray-100 font-bold text-xs uppercase"><tr className="text-left"><th className="p-2">Item</th><th className="text-right p-2">In</th><th className="text-right p-2">Out</th><th className="text-right p-2">Net</th></tr></thead>
                                                        <tbody className="divide-y">{chartData.map((d,i)=><tr key={i}><td className="p-2 font-bold">{d.label}</td><td className="p-2 text-right text-green-700">{d.in||'-'}</td><td className="p-2 text-right text-blue-700">{d.out||'-'}</td><td className="p-2 text-right font-bold">{d.in-d.out}</td></tr>)}</tbody>
                                                    </table>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>
                                <div className="p-4 border-t flex justify-end"><button onClick={()=>handlePDFReport(true)} className="bg-blue-600 text-white px-6 py-3 rounded font-bold shadow">Download PDF</button></div>
                            </div>
                        </div>
                    )}

                    {/* Report Modal (Text) */}
                    {showReportModal && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-4xl h-[90vh] rounded-xl flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center"><h3 className="font-bold">Text Report</h3><button onClick={()=>setShowReportModal(false)}><X/></button></div>
                                <div className="flex-1 overflow-auto bg-gray-100 p-4 flex justify-center">
                                    <div ref={reportCaptureRef} className="bg-white p-8 w-[800px] shadow-lg text-sm">
                                        <div className="text-center border-b-2 border-black pb-4 mb-6"><h1 className="text-2xl font-black uppercase">Daily Report</h1><div>{reportDate}</div></div>
                                        {(() => {
                                            const s = getDailyReport(reportDate);
                                            const split = s.sales.length > 8;
                                            return (
                                                <div className={`grid gap-4 ${split?'grid-cols-3':'grid-cols-2'}`}>
                                                    <div className="border-r pr-2"><h3 className="bg-green-100 text-green-900 font-bold text-center mb-2">Purchase</h3>{s.purchases.map((p,i)=><div key={i} className="border-b py-1"><div className="flex justify-between font-bold"><span>{p.name}</span><span>{p.totalB}</span></div>{p.amount>0 && <div className="text-xs text-green-600">Given: ₹{p.amount}</div>}</div>)}</div>
                                                    <div className={split?"border-r pr-2":""}><h3 className="bg-blue-100 text-blue-900 font-bold text-center mb-2">Sales</h3>{(split?s.sales.slice(0,Math.ceil(s.sales.length/2)):s.sales).map((p,i)=><div key={i} className="border-b py-1"><div className="flex justify-between font-bold"><span>{p.name}</span><span>{p.totalB}</span></div>{p.amount>0 && <div className="text-xs text-blue-600">Recv: ₹{p.amount}</div>}</div>)}</div>
                                                    {split && <div><h3 className="bg-blue-100 text-blue-900 font-bold text-center mb-2">Sales (cont.)</h3>{s.sales.slice(Math.ceil(s.sales.length/2)).map((p,i)=><div key={i} className="border-b py-1"><div className="flex justify-between font-bold"><span>{p.name}</span><span>{p.totalB}</span></div>{p.amount>0 && <div className="text-xs text-blue-600">Recv: ₹{p.amount}</div>}</div>)}</div>}
                                                </div>
                                            );
                                        })()}
                                        <div className="mt-8 pt-4 border-t-4 border-black text-right font-black text-xl">Total Expenses: ₹{getDailyReport(reportDate).totalExp}</div>
                                    </div>
                                </div>
                                <div className="p-4 border-t flex justify-end"><button onClick={()=>handlePDFReport(false)} className="bg-blue-600 text-white px-6 py-3 rounded font-bold shadow">Download PDF</button></div>
                            </div>
                        </div>
                    )}

                    {/* Direct Entry Modal */}
                    {showDirectEntry && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b flex justify-between items-center"><h3 className="font-bold flex gap-2"><FilePlus/> {editingTripId?'Edit':'Direct'} Entry / నమోదు</h3><button onClick={()=>{setShowDirectEntry(false); setTempExpenses([]);}}><X/></button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="text-[10px] font-bold uppercase">Date / తేదీ</label><input type="date" value={directData.date} onChange={e=>setDirectData({...directData,date:e.target.value})} className="w-full border p-2 rounded text-sm"/></div>
                                        <div><label className="text-[10px] font-bold uppercase">Mode</label><select value={directData.mode} onChange={e=>setDirectData({...directData,mode:e.target.value})} className="w-full border p-2 rounded text-sm"><option value="Purchase">Purchase</option><option value="Sales">Sales</option></select></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="text-[10px] font-bold uppercase">Ref No</label><input type="text" value={directData.refId} onChange={e=>setDirectData({...directData,refId:e.target.value})} className="w-full border p-2 rounded text-sm" placeholder="#123"/></div>
                                        <div><label className="text-[10px] font-bold uppercase">Party</label><input type="text" value={directData.partyName} onChange={e=>setDirectData({...directData,partyName:e.target.value})} className="w-full border p-2 rounded text-sm" placeholder="Name"/></div>
                                    </div>
                                    <div><label className="text-[10px] font-bold uppercase">{directData.mode==='Sales'?'Amount Received / స్వీకరించిన':'Amount Given / ఇచ్చిన'} (₹)</label><input type="number" value={directData.amount} onChange={e=>setDirectData({...directData,amount:e.target.value})} className="w-full border p-2 rounded text-sm font-bold"/></div>
                                    <div><label className="text-[10px] font-bold uppercase">Driver / Notes</label><input type="text" value={directData.driverName} onChange={e=>setDirectData({...directData,driverName:e.target.value})} className="w-full border p-2 rounded text-sm" placeholder="Optional"/></div>
                                    
                                    <div className="bg-gray-50 p-3 rounded border">
                                        <div className="space-y-2 mb-3">{directData.items.map((i,k)=><div key={k} className="flex justify-between bg-white p-2 rounded border text-xs"><span>{i.name}</span><span>{i.boxes} Bx</span><button onClick={()=>removeDirectItem(k)} className="text-red-500"><X size={14}/></button></div>)}</div>
                                        <div className="flex gap-2"><input list="item-suggestions" type="text" className="w-full border p-1 rounded text-sm" placeholder="Item" value={newItemName} onChange={e=>setNewItemName(e.target.value)} /><input type="number" className="w-16 border p-1 rounded text-sm" placeholder="Bx" value={newItemBoxes} onChange={e=>setNewItemBoxes(e.target.value)} /><button onClick={addItemToDirect} className="bg-green-500 text-white px-2 rounded"><Plus/></button></div>
                                    </div>

                                    <div className="bg-orange-50 p-3 rounded border">
                                        <label className="text-[10px] font-bold uppercase text-orange-800">Trip Expenses</label>
                                        <div className="space-y-1 mb-2">{tempExpenses.map(e=><div key={e.id} className="flex justify-between text-xs bg-white px-2 py-1 rounded"><span>{e.category}</span><span>₹{e.amount}</span><button onClick={()=>removeTempExpense(e.id)} className="text-red-500"><X size={10}/></button></div>)}</div>
                                        <div className="flex gap-2"><select value={tempExpenseCategory} onChange={e=>setTempExpenseCategory(e.target.value)} className="border p-1 text-xs flex-1">{['Transport','Labour','Ice','Other'].map(c=><option key={c} value={c}>{c}</option>)}</select><input type="number" value={tempExpenseAmount} onChange={e=>setTempExpenseAmount(e.target.value)} className="w-16 border p-1 text-xs" placeholder="₹"/><button onClick={addTempExpense} className="bg-orange-500 text-white px-2 rounded"><Plus/></button></div>
                                    </div>
                                </div>
                                <div className="p-4 border-t grid grid-cols-1 gap-2">
                                    <button onClick={()=>handleDirectSave(false)} className="bg-blue-600 text-white py-3 rounded font-bold">Save Record / సేవ్ చేయండి</button>
                                    <button onClick={handleDirectShare} className="bg-green-600 text-white py-3 rounded font-bold flex items-center justify-center gap-2"><Share2 size={18}/> Save & Share Image</button>
                                </div>
                                {/* Hidden Receipt */}
                                <div ref={directEntryCaptureRef} className="absolute left-[-9999px] top-0 w-[400px] bg-white p-6 text-black border border-gray-300">
                                    <div className="text-center border-b-2 border-black pb-2 mb-4"><h2 className="text-xl font-black uppercase">Receipt</h2><div className="text-sm">{directData.mode}</div></div>
                                    <div className="flex justify-between text-xs mb-1"><span className="text-gray-500">Date:</span><b>{directData.date}</b></div>
                                    <div className="flex justify-between text-xs mb-4"><span className="text-gray-500">Party:</span><b className="uppercase">{directData.partyName}</b></div>
                                    <table className="w-full text-xs mb-4 border-collapse"><thead><tr className="border-b border-black text-left"><th>Item</th><th className="text-right">Bx</th></tr></thead><tbody>{directData.items.map((i,k)=><tr key={k} className="border-b border-gray-100"><td className="py-1">{i.name}</td><td className="py-1 text-right">{i.boxes}</td></tr>)}</tbody></table>
                                    {directData.amount && <div className="flex justify-between bg-gray-100 p-2 rounded mb-2"><span className="text-xs font-bold">Paid/Recv:</span><span className="text-lg font-black">₹{directData.amount}</span></div>}
                                    {tempExpenses.length>0 && <div className="border-t pt-2"><div className="text-[10px] font-bold mb-1">Expenses</div>{tempExpenses.map(e=><div key={e.id} className="flex justify-between text-[10px]"><span>{e.category}</span><span>₹{e.amount}</span></div>)}</div>}
                                    <div className="mt-4 pt-2 border-t text-[10px] text-gray-400 flex justify-between"><span>Nellore Truck Loader</span><span>{directData.driverName}</span></div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Navigation */}
                    <div className="bg-white border-t p-2 flex justify-around items-center text-xs font-bold text-gray-500 safe-area-pb">
                        <button onClick={()=>setActiveTab('visualizer')} className={`flex flex-col items-center ${activeTab==='visualizer'?'text-blue-600':''}`}><Layers size={20}/><span>Layout</span></button>
                        <button onClick={()=>setActiveTab('share')} className={`flex flex-col items-center ${activeTab==='share'?'text-blue-600':''}`}><Camera size={20}/><span>Photo</span></button>
                        <button onClick={()=>setActiveTab('manifest')} className={`flex flex-col items-center ${activeTab==='manifest'?'text-blue-600':''}`}><FileText size={20}/><span>Manifest</span></button>
                        <button onClick={()=>setActiveTab('records')} className={`flex flex-col items-center ${activeTab==='records'?'text-blue-600':''}`}><BarChart3 size={20}/><span>Records</span></button>
                        <button onClick={()=>setActiveTab('daily')} className={`flex flex-col items-center ${activeTab==='daily'?'text-blue-600':''}`}><ClipboardList size={20}/><span>Daily</span></button>
                        <button onClick={()=>setActiveTab('settings')} className={`flex flex-col items-center ${activeTab==='settings'?'text-blue-600':''}`}><Box size={20}/><span>Config</span></button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<TruckLoadPlanner />);
    </script>
</body>
</html>
