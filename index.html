<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VAR Load Planner — Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.263.1"
    }
  }
  </script>
  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel" data-type="module">
  // ----------------- IMPORTS -----------------
  import React, { useState, useEffect, useMemo } from "react";
  import { createRoot } from "react-dom/client";
  import { createClient } from "https://esm.sh/@supabase/supabase-js";
  import { ArrowUpCircle, ArrowDownCircle, FileText, Camera, BarChart3, ClipboardList, Box, Trash2, Save } from "lucide-react";

  // --------------- SUPABASE CONFIG ---------------
  const SUPABASE_URL = "https://wlntnttsliaygrqhfazj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbnRudHRzbGlheWdycWhmYXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzMzNjIsImV4cCI6MjA4MDQwOTM2Mn0.imoQLKoDxDVOmKbLOHVDsRxX5jRORMV5cYt2sFf9wiI";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --------------- MAIN APP -----------------
  function App() {
    // basic trip form
    const [operationMode, setOperationMode] = useState("Sales");
    const [tripDate, setTripDate] = useState(new Date().toISOString().slice(0,10));
    const [driverName, setDriverName] = useState("");
    const [customerName, setCustomerName] = useState("");
    const [referenceId, setReferenceId] = useState("");
    const [targetBoxCount, setTargetBoxCount] = useState("");
    const [varBoxCount, setVarBoxCount] = useState("");

    // grid simplified representation (you can keep your original grid logic)
    const [gridBoxes, setGridBoxes] = useState([]); // array of {label,filled}
    const [batchLabel, setBatchLabel] = useState("");

    // direct entry
    const [directItems, setDirectItems] = useState([]); // {name,boxes,looseKg}
    const [dName, setDName] = useState("");
    const [dBoxes, setDBoxes] = useState("");
    const [dLoose, setDLoose] = useState("");

    // state for cloud data
    const [savedTrips, setSavedTrips] = useState([]);
    const [expenses, setExpenses] = useState([]);
    const [expenseCategory, setExpenseCategory] = useState("Labour");
    const [expenseAmount, setExpenseAmount] = useState("");
    const [expenseNote, setExpenseNote] = useState("");

    const [editingTripId, setEditingTripId] = useState(null);

    // Load on start
    useEffect(() => {
      loadTrips();
      loadExpenses();
    }, []);

    // ---------- SUPABASE CRUD ----------
    async function loadTrips() {
      try {
        const { data, error } = await supabase
          .from("trips")
          .select("*")
          .order("timestamp", { ascending: false });
        if (error) throw error;
        setSavedTrips(Array.isArray(data) ? data : []);
      } catch (err) {
        console.error("loadTrips failed", err);
        alert("Failed to load trips from Supabase. Check console.");
      }
    }

    async function loadExpenses() {
      try {
        const { data, error } = await supabase
          .from("expenses")
          .select("*")
          .order("timestamp", { ascending: false });
        if (error) throw error;
        setExpenses(Array.isArray(data) ? data : []);
      } catch (err) {
        console.error("loadExpenses failed", err);
      }
    }

    function computeManifestFromGrid() {
      // if you have complex grid logic, adapt here.
      // current simple approach: totalBoxes = count of filled labels
      let totalBoxes = 0;
      const summary = {};
      gridBoxes.forEach(b => {
        if (b.filled) {
          totalBoxes++;
          const name = (b.label || "Unlabeled").trim();
          summary[name] = (summary[name] || 0) + 1;
        }
      });
      return { totalBoxes, summary };
    }

    // Save Trip (truck mode)
    async function saveTrip() {
      const { totalBoxes, summary } = computeManifestFromGrid();
      if (totalBoxes === 0) return alert("Cannot save empty trip");

      const newTrip = {
        tripDate,
        operationMode,
        driverName,
        customerName,
        referenceId,
        targetBoxCount: targetBoxCount ? Number(targetBoxCount) : null,
        varBoxCount: varBoxCount ? Number(varBoxCount) : null,
        totalBoxes,
        summary,
        detailedItems: null,
        isDirectEntry: false,
        timestamp: Date.now()
      };

      try {
        const { data, error } = await supabase.from("trips").insert([newTrip]).select();
        if (error) throw error;
        const saved = data[0];
        setSavedTrips(prev => [saved, ...prev]);
        if (window.confirm("Trip saved to cloud. Start a new load?")) {
          // clear grid form
          setGridBoxes([]);
          setBatchLabel("");
          setDriverName("");
          setCustomerName("");
          setVarBoxCount("");
          setTargetBoxCount("");
          setReferenceId("");
        }
      } catch (err) {
        console.error("saveTrip error", err);
        alert("Save failed. See console.");
      }
    }

    // Direct entry save (purchase or sales)
    async function saveDirectEntry({ shouldDownload = false } = {}) {
      if (directItems.length === 0) return alert("Add at least one item");
      if (!customerName && !driverName) return alert("Enter party or driver name");

      let totalBoxes = 0;
      const summary = {};
      directItems.forEach(it => {
        const qty = Number(it.boxes) || 0;
        totalBoxes += qty;
        const nm = it.name.trim();
        summary[nm] = (summary[nm] || 0) + qty;
      });

      const newRecord = {
        tripDate,
        operationMode,
        driverName: driverName || "Direct Entry",
        customerName: customerName || "Direct",
        referenceId: referenceId || "DIRECT",
        targetBoxCount: null,
        varBoxCount: null,
        totalBoxes,
        summary,
        detailedItems: directItems,
        isDirectEntry: true,
        timestamp: Date.now()
      };

      try {
        let savedTrip;
        if (editingTripId) {
          const { data, error } = await supabase.from("trips").update(newRecord).eq("id", editingTripId).select();
          if (error) throw error;
          savedTrip = data[0];
          setSavedTrips(prev => prev.map(t => t.id === editingTripId ? savedTrip : t));
        } else {
          const { data, error } = await supabase.from("trips").insert([newRecord]).select();
          if (error) throw error;
          savedTrip = data[0];
          setSavedTrips(prev => [savedTrip, ...prev]);
        }

        // if you had temp expenses linked to this direct entry, you'd insert them here with tripId = savedTrip.id

        if (shouldDownload) {
          // small CSV export for this record
          const rows = directItems.map(it => [tripDate, operationMode, customerName || driverName, referenceId || 'DIRECT', it.name, it.boxes, it.looseKg || 0].join(","));
          const csv = ["Date,Mode,Party,Ref,Item,Boxes,LooseKg", ...rows].join("\n");
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = `DirectEntry_${tripDate}.csv`; a.click();
        }

        // reset
        setDirectItems([]);
        setDName(""); setDBoxes(""); setDLoose("");
        setReferenceId(""); setCustomerName(""); setDriverName("");
        setEditingTripId(null);
        alert(editingTripId ? "Updated!" : "Saved!");
      } catch (err) {
        console.error("saveDirectEntry error", err);
        alert("Failed to save direct entry");
      }
    }

    // Delete trip and its expenses
    async function deleteTrip(id) {
      if (!window.confirm("Delete this record? This will also delete expenses for it.")) return;
      try {
        await supabase.from("expenses").delete().eq("tripId", id);
        await supabase.from("trips").delete().eq("id", id);
        setSavedTrips(prev => prev.filter(t => t.id !== id));
        setExpenses(prev => prev.filter(e => e.tripId !== id));
      } catch (err) {
        console.error("deleteTrip error", err);
        alert("Delete failed");
      }
    }

    // Add a simple expense (not linked to a trip)
    async function addExpense() {
      if (!expenseAmount) return alert("Enter amount");
      const newExp = {
        tripId: null,
        category: expenseCategory,
        amount: parseFloat(expenseAmount),
        note: expenseNote || "",
        date: tripDate,
        timestamp: Date.now()
      };
      try {
        const { data, error } = await supabase.from("expenses").insert([newExp]).select();
        if (error) throw error;
        setExpenses(prev => [data[0], ...prev]);
        setExpenseAmount(""); setExpenseNote("");
      } catch (err) {
        console.error("addExpense error", err);
        alert("Failed to save expense");
      }
    }

    // Add item to direct entry list
    function addDirectItem() {
      if (!dName || !dBoxes) return alert("Enter item and boxes");
      setDirectItems(prev => [...prev, { name: dName, boxes: Number(dBoxes), looseKg: Number(dLoose) || 0 }]);
      setDName(""); setDBoxes(""); setDLoose("");
    }

    // Quick CSV export for all trips
    function exportCSV() {
      if (!savedTrips.length) return alert("No records");
      const headers = ["Date","Mode","Driver","Customer","Ref","TotalBoxes","Direct","Summary"];
      const rows = savedTrips.map(t => [
        t.tripDate, t.operationMode, t.driverName || "-", t.customerName || "-", t.referenceId || "-", t.totalBoxes, t.isDirectEntry ? "Direct":"Truck", JSON.stringify(t.summary)
      ].join(","));
      const csv = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `var_records_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    }

    // --------------- UI ----------------
    return (
      <div className="max-w-3xl mx-auto p-4">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            {operationMode === "Sales" ? <ArrowUpCircle/> : <ArrowDownCircle/>}
            <h1 className="text-xl font-bold">VAR Load Planner (Supabase)</h1>
          </div>
          <div className="text-sm text-gray-600">Cloud: wlntntts...supabase.co</div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {/* Trip / Direct Entry Form */}
          <div className="bg-white p-4 rounded shadow">
            <div className="flex gap-2 mb-2">
              <select className="border p-2 flex-1" value={operationMode} onChange={e => setOperationMode(e.target.value)}>
                <option>Sales</option>
                <option>Purchase</option>
              </select>
              <input className="border p-2" type="date" value={tripDate} onChange={e => setTripDate(e.target.value)} />
            </div>

            <input className="border w-full p-2 mb-2" placeholder="Driver name / Party" value={driverName} onChange={e => setDriverName(e.target.value)} />
            <input className="border w-full p-2 mb-2" placeholder="Customer / Party" value={customerName} onChange={e => setCustomerName(e.target.value)} />
            <div className="flex gap-2 mb-2">
              <input className="border p-2 flex-1" placeholder="Reference ID" value={referenceId} onChange={e => setReferenceId(e.target.value)} />
              <input className="border p-2 w-28" placeholder="Target" value={targetBoxCount} onChange={e => setTargetBoxCount(e.target.value)} />
              <input className="border p-2 w-28" placeholder="Var" value={varBoxCount} onChange={e => setVarBoxCount(e.target.value)} />
            </div>

            <div className="mb-2">
              <label className="text-sm font-semibold">Grid Batch Input (simple)</label>
              <div className="flex gap-2 mt-1">
                <input className="border p-2 flex-1" placeholder="Label for boxes" value={batchLabel} onChange={e => setBatchLabel(e.target.value)} />
                <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={() => {
                  if (!batchLabel) return alert("Enter label");
                  // add 5 filled boxes quickly (you can change)
                  const arr = [...gridBoxes];
                  for (let i=0;i<5;i++) arr.push({ label: batchLabel, filled: true });
                  setGridBoxes(arr);
                }}>Fill</button>
              </div>
              <div className="mt-2 text-xs text-gray-500">Grid boxes: {gridBoxes.filter(b=>b.filled).length}</div>
            </div>

            <div className="flex gap-2 mt-3">
              <button className="bg-green-600 text-white px-3 py-2 rounded flex items-center gap-2" onClick={saveTrip}><Save/> Save Trip</button>
              <button className="bg-yellow-500 text-white px-3 py-2 rounded" onClick={() => {
                // reset form
                setGridBoxes([]); setBatchLabel(""); setDriverName(""); setCustomerName("");
                setTargetBoxCount(""); setVarBoxCount(""); setReferenceId("");
              }}>Reset</button>
            </div>
          </div>

          {/* Direct Entry & Expenses */}
          <div className="bg-white p-4 rounded shadow">
            <h3 className="font-semibold mb-2">Direct Entry (Purchase/Sale)</h3>
            <div className="flex gap-2 mb-2">
              <input className="border p-2 flex-1" placeholder="Item name" value={dName} onChange={e => setDName(e.target.value)} />
              <input className="border p-2 w-24" placeholder="Boxes" value={dBoxes} onChange={e => setDBoxes(e.target.value)} />
              <input className="border p-2 w-24" placeholder="Loose Kg" value={dLoose} onChange={e => setDLoose(e.target.value)} />
              <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={addDirectItem}>Add</button>
            </div>

            <div className="max-h-36 overflow-auto mb-2 border p-2">
              {directItems.length === 0 ? <div className="text-xs text-gray-500">No items</div> :
                directItems.map((it, idx) => <div key={idx} className="flex justify-between items-center py-1">
                  <div>{it.name} — {it.boxes} Bx {it.looseKg ? `+${it.looseKg} Kg` : ""}</div>
                  <button className="text-red-500" onClick={() => setDirectItems(directItems.filter((_,i)=>i!==idx))}>Remove</button>
                </div>)}
            </div>

            <div className="flex gap-2">
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={() => saveDirectEntry({ shouldDownload: false })}>Save Direct</button>
              <button className="bg-gray-600 text-white px-3 py-2 rounded" onClick={() => saveDirectEntry({ shouldDownload: true })}>Save & Download CSV</button>
            </div>

            <hr className="my-3" />

            <h3 className="font-semibold mb-2">Expenses</h3>
            <div className="flex gap-2 mb-2">
              <select className="border p-2" value={expenseCategory} onChange={e => setExpenseCategory(e.target.value)}>
                <option>Labour</option>
                <option>Transport</option>
                <option>Feed</option>
                <option>Other</option>
              </select>
              <input className="border p-2 w-32" placeholder="Amount" value={expenseAmount} onChange={e => setExpenseAmount(e.target.value)} />
              <input className="border p-2 flex-1" placeholder="Note" value={expenseNote} onChange={e => setExpenseNote(e.target.value)} />
              <button className="bg-green-600 text-white px-3 py-2 rounded" onClick={addExpense}>Add</button>
            </div>

            <div className="max-h-36 overflow-auto">
              {expenses.map(e => <div key={e.id} className="flex justify-between items-center py-1 text-sm">
                <div>{e.category} — ₹{e.amount} <span className="text-xs text-gray-400">({e.date})</span></div>
                <button className="text-red-500" onClick={async ()=> {
                  if (!confirm("Delete expense?")) return;
                  try {
                    const { error } = await supabase.from("expenses").delete().eq("id", e.id);
                    if (error) throw error;
                    setExpenses(prev => prev.filter(x => x.id !== e.id));
                  } catch (err) { console.error(err); alert("Delete failed"); }
                }}>Delete</button>
              </div>)}
            </div>
          </div>
        </div>

        <div className="mt-6 bg-white p-4 rounded shadow">
          <div className="flex justify-between items-center mb-3">
            <h3 className="font-semibold">Saved Records</h3>
            <div className="flex gap-2">
              <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={exportCSV}>Export CSV</button>
              <button className="bg-red-600 text-white px-3 py-2 rounded" onClick={async ()=> {
                if (!confirm("Delete ALL trips and expenses?")) return;
                try {
                  await supabase.from("expenses").delete();
                  await supabase.from("trips").delete();
                  setSavedTrips([]); setExpenses([]);
                  alert("All cleared");
                } catch (err) { console.error(err); alert("Clear failed"); }
              }}>Clear All Cloud</button>
            </div>
          </div>

          <div className="max-h-96 overflow-auto">
            {savedTrips.length === 0 ? <div className="text-sm text-gray-500">No records yet</div> :
              savedTrips.map(t => (
                <div key={t.id} className="border-b py-2">
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="font-semibold">{t.operationMode} — {t.tripDate} <span className="text-xs text-gray-400">#{t.id}</span></div>
                      <div className="text-sm text-gray-600">{t.driverName} / {t.customerName} — Boxes: {t.totalBoxes}</div>
                      <div className="text-xs text-gray-500">Ref: {t.referenceId || '-'}</div>
                    </div>
                    <div className="flex gap-2">
                      <button className="text-sm px-2 py-1 border rounded" onClick={() => {
                        // populate direct edit form from record
                        setEditingTripId(t.id);
                        setTripDate(t.tripDate);
                        setOperationMode(t.operationMode);
                        setDriverName(t.driverName || "");
                        setCustomerName(t.customerName || "");
                        setReferenceId(t.referenceId || "");
                        setDirectItems(t.detailedItems && t.detailedItems.length ? t.detailedItems : Object.entries(t.summary || {}).map(([name,count])=>({name,boxes:count,looseKg:0})));
                        window.scrollTo({ top: 0, behavior: "smooth" });
                      }}>Edit</button>
                      <button className="text-red-500 px-2 py-1" onClick={() => deleteTrip(t.id)}><Trash2/></button>
                    </div>
                  </div>
                </div>
              ))}
          </div>
        </div>

        <div className="text-center text-xs text-gray-500 mt-4">Supabase Project: wlntnttsliaygrqhfazj (anon key used in frontend)</div>
      </div>
    );
  }

  const root = createRoot(document.getElementById("root"));
  root.render(<App />);
  </script>
</body>
</html>
